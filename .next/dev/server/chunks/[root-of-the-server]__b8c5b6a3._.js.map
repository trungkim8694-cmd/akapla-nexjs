{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 136, "column": 0}, "map": {"version":3,"sources":["file:///D:/TULAPTRINH/akapla-nextjs/app/api/rfq/route.ts"],"sourcesContent":["import { google } from \"googleapis\";\nimport { Readable } from \"stream\";\nimport { NextResponse } from \"next/server\";\nimport { Buffer } from \"buffer\";\n\nexport async function POST(req: Request) {\n  try {\n    const formData = await req.formData();\n    const companyName = formData.get(\"companyName\") as string;\n    const contactEmail = formData.get(\"contactEmail\") as string;\n    const productType = formData.get(\"productType\") as string;\n    const notes = formData.get(\"notes\") as string;\n    const requestVisitOrPrototype = formData.get(\n      \"requestVisitOrPrototype\",\n    ) as string;\n    const file = formData.get(\"file\") as File | null;\n\n    // 1. Xử lý thông tin xác thực (Fix lỗi ERR_OSSL_UNSUPPORTED)\n    const rawCredentials = JSON.parse(\n      process.env.GOOGLE_SERVICE_ACCOUNT_KEY || \"{}\",\n    );\n\n    // Quan trọng: Thay thế ký tự xuống dòng giả bằng ký tự xuống dòng thật cho Private Key\n    if (rawCredentials.private_key) {\n      rawCredentials.private_key = rawCredentials.private_key.replace(\n        /\\\\n/g,\n        \"\\n\",\n      );\n    }\n\n    const auth = new google.auth.GoogleAuth({\n      credentials: rawCredentials,\n      scopes: [\n        \"https://www.googleapis.com/auth/drive.file\",\n        \"https://www.googleapis.com/auth/spreadsheets\",\n      ],\n    });\n\n    let fileUrl = \"No file uploaded\";\n\n    // 2. Tải file lên Google Drive nếu có\n    if (file && file.size > 0) {\n      try {\n        const drive = google.drive({ version: \"v3\", auth });\n        const buffer = Buffer.from(await file.arrayBuffer());\n\n        const driveResponse = await drive.files.create({\n          requestBody: {\n            name: `${new Date().getTime()}_${file.name}`,\n            // parents: [process.env.GOOGLE_DRIVE_FOLDER_ID!],\n          },\n          media: {\n            body: Readable.from(buffer),\n          },\n          // Ép buộc sử dụng dung lượng của người dùng sở hữu thư mục\n          useContentInspectedQuota: true,\n          supportsAllDrives: true,\n          fields: \"id, webViewLink\",\n        } as any);\n\n        const fileId = driveResponse.data.id;\n\n        // --- THÊM KHỐI NÀY để làm cho tệp có thể truy cập qua liên kết ---\n        if (fileId) {\n          await drive.permissions.create({\n            fileId: fileId,\n            requestBody: {\n              role: \"reader\",\n              type: \"anyone\", // Hoặc \"user\" nếu bạn muốn hạn chế\n            },\n            supportsAllDrives: true,\n          });\n        }\n        // -----------------------------------------------------\n\n        fileUrl = driveResponse.data.webViewLink || \"Link generation failed\";\n      } catch (driveError: any) {\n        console.error(\"Drive Error:\", driveError.message);\n        fileUrl = \"Upload failed: \" + driveError.message;\n      }\n    }\n\n    // 3. Ghi dữ liệu vào Google Sheets\n    const sheets = google.sheets({ version: \"v4\", auth });\n\n    // Đảm bảo dải ô (range) khớp với số lượng cột bạn gửi đi (7 cột: A đến G)\n    await sheets.spreadsheets.values.append({\n      spreadsheetId: process.env.GOOGLE_SHEET_ID,\n      range: \"Sheet1!A:G\",\n      valueInputOption: \"USER_ENTERED\",\n      requestBody: {\n        values: [\n          [\n            new Date().toLocaleString(\"ja-JP\", { timeZone: \"Asia/Tokyo\" }), // Cột A: Timestamp\n            companyName || \"\", // Cột B\n            contactEmail || \"\", // Cột C\n            productType || \"\", // Cột D\n            requestVisitOrPrototype || \"\", // Cột E\n            notes || \"\", // Cột F\n            fileUrl, // Cột G\n          ],\n        ],\n      },\n    });\n\n    return NextResponse.json({ success: true });\n  } catch (error: any) {\n    // In lỗi chi tiết ra Terminal của VS Code để bạn kiểm tra\n    console.error(\"RFQ Backend Critical Error:\", {\n      message: error.message,\n      stack: error.stack,\n      code: error.code,\n    });\n\n    return NextResponse.json(\n      { success: false, error: error.message || \"Internal Server Error\" },\n      { status: 500 },\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;AACA;;;;;AAEO,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,WAAW,MAAM,IAAI,QAAQ;QACnC,MAAM,cAAc,SAAS,GAAG,CAAC;QACjC,MAAM,eAAe,SAAS,GAAG,CAAC;QAClC,MAAM,cAAc,SAAS,GAAG,CAAC;QACjC,MAAM,QAAQ,SAAS,GAAG,CAAC;QAC3B,MAAM,0BAA0B,SAAS,GAAG,CAC1C;QAEF,MAAM,OAAO,SAAS,GAAG,CAAC;QAE1B,6DAA6D;QAC7D,MAAM,iBAAiB,KAAK,KAAK,CAC/B,QAAQ,GAAG,CAAC,0BAA0B,IAAI;QAG5C,uFAAuF;QACvF,IAAI,eAAe,WAAW,EAAE;YAC9B,eAAe,WAAW,GAAG,eAAe,WAAW,CAAC,OAAO,CAC7D,QACA;QAEJ;QAEA,MAAM,OAAO,IAAI,+JAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YACtC,aAAa;YACb,QAAQ;gBACN;gBACA;aACD;QACH;QAEA,IAAI,UAAU;QAEd,sCAAsC;QACtC,IAAI,QAAQ,KAAK,IAAI,GAAG,GAAG;YACzB,IAAI;gBACF,MAAM,QAAQ,+JAAM,CAAC,KAAK,CAAC;oBAAE,SAAS;oBAAM;gBAAK;gBACjD,MAAM,SAAS,+GAAM,CAAC,IAAI,CAAC,MAAM,KAAK,WAAW;gBAEjD,MAAM,gBAAgB,MAAM,MAAM,KAAK,CAAC,MAAM,CAAC;oBAC7C,aAAa;wBACX,MAAM,GAAG,IAAI,OAAO,OAAO,GAAG,CAAC,EAAE,KAAK,IAAI,EAAE;oBAE9C;oBACA,OAAO;wBACL,MAAM,iHAAQ,CAAC,IAAI,CAAC;oBACtB;oBACA,2DAA2D;oBAC3D,0BAA0B;oBAC1B,mBAAmB;oBACnB,QAAQ;gBACV;gBAEA,MAAM,SAAS,cAAc,IAAI,CAAC,EAAE;gBAEpC,oEAAoE;gBACpE,IAAI,QAAQ;oBACV,MAAM,MAAM,WAAW,CAAC,MAAM,CAAC;wBAC7B,QAAQ;wBACR,aAAa;4BACX,MAAM;4BACN,MAAM;wBACR;wBACA,mBAAmB;oBACrB;gBACF;gBACA,wDAAwD;gBAExD,UAAU,cAAc,IAAI,CAAC,WAAW,IAAI;YAC9C,EAAE,OAAO,YAAiB;gBACxB,QAAQ,KAAK,CAAC,gBAAgB,WAAW,OAAO;gBAChD,UAAU,oBAAoB,WAAW,OAAO;YAClD;QACF;QAEA,mCAAmC;QACnC,MAAM,SAAS,+JAAM,CAAC,MAAM,CAAC;YAAE,SAAS;YAAM;QAAK;QAEnD,0EAA0E;QAC1E,MAAM,OAAO,YAAY,CAAC,MAAM,CAAC,MAAM,CAAC;YACtC,eAAe,QAAQ,GAAG,CAAC,eAAe;YAC1C,OAAO;YACP,kBAAkB;YAClB,aAAa;gBACX,QAAQ;oBACN;wBACE,IAAI,OAAO,cAAc,CAAC,SAAS;4BAAE,UAAU;wBAAa;wBAC5D,eAAe;wBACf,gBAAgB;wBAChB,eAAe;wBACf,2BAA2B;wBAC3B,SAAS;wBACT;qBACD;iBACF;YACH;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAO,OAAY;QACnB,0DAA0D;QAC1D,QAAQ,KAAK,CAAC,+BAA+B;YAC3C,SAAS,MAAM,OAAO;YACtB,OAAO,MAAM,KAAK;YAClB,MAAM,MAAM,IAAI;QAClB;QAEA,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO,IAAI;QAAwB,GAClE;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}