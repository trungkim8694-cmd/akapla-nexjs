{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 154, "column": 0}, "map": {"version":3,"sources":["file:///D:/TULAPTRINH/akapla-nextjs/app/api/rfq/route.ts"],"sourcesContent":["import { google } from \"googleapis\";\nimport { NextResponse } from \"next/server\";\nimport admin from \"firebase-admin\";\nimport nodemailer from \"nodemailer\";\n\n// Kh·ªüi t·∫°o Firebase Admin\nif (!admin.apps.length) {\n  const rawCredentials = JSON.parse(\n    process.env.GOOGLE_SERVICE_ACCOUNT_KEY || \"{}\",\n  );\n  if (rawCredentials.private_key) {\n    rawCredentials.private_key = rawCredentials.private_key.replace(\n      /\\\\n/g,\n      \"\\n\",\n    );\n  }\n  admin.initializeApp({\n    credential: admin.credential.cert(rawCredentials),\n    storageBucket: process.env.FIREBASE_STORAGE_BUCKET?.replace(\"gs://\", \"\"),\n  });\n}\n\nconst bucket = admin.storage().bucket();\n\nexport async function POST(req: Request) {\n  try {\n    const formData = await req.formData();\n    const companyName = formData.get(\"companyName\") as string;\n    const contactEmail = formData.get(\"contactEmail\") as string;\n    const productType = formData.get(\"productType\") as string;\n    const notes = formData.get(\"notes\") as string;\n    const requestVisitOrPrototype = formData.get(\n      \"requestVisitOrPrototype\",\n    ) as string;\n    const file = formData.get(\"file\") as File | null;\n\n    let fileUrl = \"No file uploaded\";\n\n    // 1. T·∫£i file l√™n Firebase Storage\n    if (file && file.size > 0) {\n      const buffer = Buffer.from(await file.arrayBuffer());\n      const safeName = `${Date.now()}_${file.name.replace(/\\s+/g, \"_\")}`;\n      const blob = bucket.file(`rfq_drawings/${safeName}`);\n      await blob.save(buffer, { contentType: file.type, public: true });\n      fileUrl = `https://firebasestorage.googleapis.com/v0/b/${bucket.name}/o/${encodeURIComponent(blob.name)}?alt=media`;\n    }\n\n    // 2. Ghi d·ªØ li·ªáu v√†o Google Sheets\n    const rawCredentials = JSON.parse(\n      process.env.GOOGLE_SERVICE_ACCOUNT_KEY || \"{}\",\n    );\n    if (rawCredentials.private_key) {\n      rawCredentials.private_key = rawCredentials.private_key.replace(\n        /\\\\n/g,\n        \"\\n\",\n      );\n    }\n    const auth = new google.auth.GoogleAuth({\n      credentials: rawCredentials,\n      scopes: [\"https://www.googleapis.com/auth/spreadsheets\"],\n    });\n    const sheets = google.sheets({ version: \"v4\", auth });\n    const timestamp = new Date().toLocaleString(\"ja-JP\", {\n      timeZone: \"Asia/Tokyo\",\n    });\n\n    await sheets.spreadsheets.values.append({\n      spreadsheetId: process.env.GOOGLE_SHEET_ID,\n      range: \"Sheet1!A:G\",\n      valueInputOption: \"USER_ENTERED\",\n      requestBody: {\n        values: [\n          [\n            timestamp,\n            companyName,\n            contactEmail,\n            productType,\n            requestVisitOrPrototype,\n            notes,\n            fileUrl,\n          ],\n        ],\n      },\n    });\n\n    // 3. G·ª≠i th√¥ng b√°o TELEGRAM cho b·∫°n (M·∫´u chuy√™n nghi·ªáp)\n    const telegramToken = process.env.TELEGRAM_BOT_TOKEN;\n    const chatId = process.env.TELEGRAM_CHAT_ID;\n\n    // ƒê·ªãnh d·∫°ng tin nh·∫Øn v·ªõi Emoji v√† xu·ªëng d√≤ng r√µ r√†ng\n    const telegramMsg = `\nüîî *[RFQ] Y√™u c·∫ßu b√°o gi√° m·ªõi* üîî\n\nüè¢ *C√¥ng ty:* ${companyName}\nüë§ *Email:* ${contactEmail}\nüì¶ *S·∫£n ph·∫©m:* ${productType}\nüõ† *Y√™u c·∫ßu:* ${requestVisitOrPrototype}\nüìù *Ghi ch√∫:* ${notes || \"Kh√¥ng c√≥\"}\n\nüìé *T·ªáp ƒë√≠nh k√®m:* [Xem t·∫°i ƒë√¢y](${fileUrl})\n`;\n\n    try {\n      await fetch(`https://api.telegram.org/bot${telegramToken}/sendMessage`, {\n        method: \"POST\",\n        headers: { \"Content-Type\": \"application/json\" },\n        body: JSON.stringify({\n          chat_id: chatId,\n          text: telegramMsg,\n          parse_mode: \"Markdown\", // Gi√∫p in ƒë·∫≠m v√† t·∫°o link\n        }),\n      });\n    } catch (err) {\n      console.error(\"Telegram Error:\", err);\n    }\n\n    // 4. G·ª≠i GMAIL TI·∫æNG NH·∫¨T cho kh√°ch h√†ng\n    const transporter = nodemailer.createTransport({\n      service: \"gmail\",\n      auth: { user: process.env.EMAIL_USER, pass: process.env.EMAIL_PASS },\n    });\n\n    try {\n      await transporter.sendMail({\n        from: `\"AKAPLA Connector\" <${process.env.EMAIL_USER}>`,\n        to: contactEmail,\n        subject: \"„ÄêAKAPLA Connector„Äë„ÅäË¶ãÁ©ç„Çä‰æùÈ†º„ÇíÊâø„Çä„Åæ„Åó„Åü\",\n        html: `\n          <p>${companyName} Êßò</p>\n          <p>„Åì„ÅÆÂ∫¶„ÅØ„ÅäË¶ãÁ©ç„Çä„Çí„Åî‰æùÈ†º„ÅÑ„Åü„Å†„Åç„ÄÅË™†„Å´„ÅÇ„Çä„Åå„Å®„ÅÜ„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ<br>AKAPLA Connector„Åß„Åî„Åñ„ÅÑ„Åæ„Åô„ÄÇ</p>\n          <p>‰ª•‰∏ã„ÅÆÂÜÖÂÆπ„Åß„ÅäÂïè„ÅÑÂêà„Çè„Åõ„ÇíÊâø„Çä„Åæ„Åó„Åü„ÄÇ</p>\n          <hr>\n          <p><b>„ÅäÂïè„ÅÑÂêà„Çè„ÅõÊó•ÊôÇ:</b> ${timestamp}</p>\n          <p><b>Ë£ΩÂìÅÁ®ÆÂà•:</b> ${productType}</p>\n          <p><b>ÂÇôËÄÉ:</b> ${notes || \"„Å™„Åó\"}</p>\n          <hr>\n          <p>ÂÜÖÂÆπ„ÇíÁ¢∫Ë™ç„ÅÆ‰∏ä„ÄÅÈÄöÂ∏∏48ÊôÇÈñì‰ª•ÂÜÖÔºà‰ºëÊó•„ÇíÈô§„ÅèÔºâ„Å´ÊãÖÂΩìËÄÖ„Çà„Çä„ÅîÈÄ£Áµ°„ÇíÂ∑Æ„Åó‰∏ä„Åí„Åæ„Åô„ÄÇ</p>\n          <p>‰ªä„Åó„Å∞„Çâ„Åè„ÅäÂæÖ„Å°„ÅÑ„Åü„Å†„Åë„Åæ„Åô„Çà„ÅÜ„ÅäÈ°ò„ÅÑÁî≥„Åó‰∏ä„Åí„Åæ„Åô„ÄÇ</p>\n          <br>\n          <p>--------------------------------------------------</p>\n          <p><b>AKAPLA Connector Team</b></p>\n          <p>Website: your-website.com</p>\n          <p>--------------------------------------------------</p>\n        `,\n      });\n    } catch (err) {\n      console.error(\"Gmail Error:\", err);\n    }\n\n    return NextResponse.json({ success: true });\n  } catch (error: any) {\n    console.error(\"Critical Error:\", error);\n    return NextResponse.json(\n      { success: false, error: error.message },\n      { status: 500 },\n    );\n  }\n}\n"],"names":[],"mappings":"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"}}]
}