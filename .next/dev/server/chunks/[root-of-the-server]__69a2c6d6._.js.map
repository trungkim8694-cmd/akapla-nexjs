{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 130, "column": 0}, "map": {"version":3,"sources":["file:///D:/TULAPTRINH/akapla-nextjs/app/api/rfq/route.ts"],"sourcesContent":["import { google } from \"googleapis\";\nimport { NextResponse } from \"next/server\";\nimport admin from \"firebase-admin\";\n\n// Khởi tạo Firebase Admin\nif (!admin.apps.length) {\n  const rawCredentials = JSON.parse(\n    process.env.GOOGLE_SERVICE_ACCOUNT_KEY || \"{}\",\n  );\n  if (rawCredentials.private_key) {\n    rawCredentials.private_key = rawCredentials.private_key.replace(\n      /\\\\n/g,\n      \"\\n\",\n    );\n  }\n\n  admin.initializeApp({\n    credential: admin.credential.cert(rawCredentials),\n    // Đảm bảo FIREBASE_STORAGE_BUCKET trong .env không có gs://\n    storageBucket: process.env.FIREBASE_STORAGE_BUCKET?.replace(\"gs://\", \"\"),\n  });\n}\n\nconst bucket = admin.storage().bucket();\n\nexport async function POST(req: Request) {\n  try {\n    const formData = await req.formData();\n    const companyName = formData.get(\"companyName\") as string;\n    const contactEmail = formData.get(\"contactEmail\") as string;\n    const productType = formData.get(\"productType\") as string;\n    const notes = formData.get(\"notes\") as string;\n    const requestVisitOrPrototype = formData.get(\n      \"requestVisitOrPrototype\",\n    ) as string;\n    const file = formData.get(\"file\") as File | null;\n\n    let fileUrl = \"No file uploaded\";\n\n    // 1. Tải file lên Firebase Storage\n    if (file && file.size > 0) {\n      try {\n        const buffer = Buffer.from(await file.arrayBuffer());\n        // Tạo tên file an toàn để link không bị hỏng\n        const safeName = `${Date.now()}_${file.name.replace(/\\s+/g, \"_\")}`;\n        const blob = bucket.file(`rfq_drawings/${safeName}`);\n\n        await blob.save(buffer, {\n          contentType: file.type,\n          public: true, // Cho phép xem công khai\n        });\n\n        // Link chuẩn Firebase để xem được ngay trong Sheets\n        fileUrl = `https://firebasestorage.googleapis.com/v0/b/${bucket.name}/o/${encodeURIComponent(blob.name)}?alt=media`;\n      } catch (uploadError: any) {\n        console.error(\"Firebase Error:\", uploadError.message);\n        fileUrl = \"Upload failed: \" + uploadError.message;\n      }\n    }\n\n    // 2. Ghi dữ liệu vào Google Sheets (Giữ nguyên logic cũ)\n    const rawCredentials = JSON.parse(\n      process.env.GOOGLE_SERVICE_ACCOUNT_KEY || \"{}\",\n    );\n    if (rawCredentials.private_key) {\n      rawCredentials.private_key = rawCredentials.private_key.replace(\n        /\\\\n/g,\n        \"\\n\",\n      );\n    }\n\n    const auth = new google.auth.GoogleAuth({\n      credentials: rawCredentials,\n      scopes: [\"https://www.googleapis.com/auth/spreadsheets\"],\n    });\n\n    const sheets = google.sheets({ version: \"v4\", auth });\n\n    await sheets.spreadsheets.values.append({\n      spreadsheetId: process.env.GOOGLE_SHEET_ID,\n      range: \"Sheet1!A:G\",\n      valueInputOption: \"USER_ENTERED\",\n      requestBody: {\n        values: [\n          [\n            new Date().toLocaleString(\"ja-JP\", { timeZone: \"Asia/Tokyo\" }),\n            companyName || \"\",\n            contactEmail || \"\",\n            productType || \"\",\n            requestVisitOrPrototype || \"\",\n            notes || \"\",\n            fileUrl,\n          ],\n        ],\n      },\n    });\n\n    return NextResponse.json({ success: true });\n  } catch (error: any) {\n    console.error(\"Critical Error:\", error);\n    return NextResponse.json(\n      { success: false, error: error.message },\n      { status: 500 },\n    );\n  }\n}\n"],"names":[],"mappings":";;;;AAAA;AACA;AACA;;;;AAEA,0BAA0B;AAC1B,IAAI,CAAC,8LAAK,CAAC,IAAI,CAAC,MAAM,EAAE;IACtB,MAAM,iBAAiB,KAAK,KAAK,CAC/B,QAAQ,GAAG,CAAC,0BAA0B,IAAI;IAE5C,IAAI,eAAe,WAAW,EAAE;QAC9B,eAAe,WAAW,GAAG,eAAe,WAAW,CAAC,OAAO,CAC7D,QACA;IAEJ;IAEA,8LAAK,CAAC,aAAa,CAAC;QAClB,YAAY,8LAAK,CAAC,UAAU,CAAC,IAAI,CAAC;QAClC,4DAA4D;QAC5D,eAAe,QAAQ,GAAG,CAAC,uBAAuB,EAAE,QAAQ,SAAS;IACvE;AACF;AAEA,MAAM,SAAS,8LAAK,CAAC,OAAO,GAAG,MAAM;AAE9B,eAAe,KAAK,GAAY;IACrC,IAAI;QACF,MAAM,WAAW,MAAM,IAAI,QAAQ;QACnC,MAAM,cAAc,SAAS,GAAG,CAAC;QACjC,MAAM,eAAe,SAAS,GAAG,CAAC;QAClC,MAAM,cAAc,SAAS,GAAG,CAAC;QACjC,MAAM,QAAQ,SAAS,GAAG,CAAC;QAC3B,MAAM,0BAA0B,SAAS,GAAG,CAC1C;QAEF,MAAM,OAAO,SAAS,GAAG,CAAC;QAE1B,IAAI,UAAU;QAEd,mCAAmC;QACnC,IAAI,QAAQ,KAAK,IAAI,GAAG,GAAG;YACzB,IAAI;gBACF,MAAM,SAAS,OAAO,IAAI,CAAC,MAAM,KAAK,WAAW;gBACjD,6CAA6C;gBAC7C,MAAM,WAAW,GAAG,KAAK,GAAG,GAAG,CAAC,EAAE,KAAK,IAAI,CAAC,OAAO,CAAC,QAAQ,MAAM;gBAClE,MAAM,OAAO,OAAO,IAAI,CAAC,CAAC,aAAa,EAAE,UAAU;gBAEnD,MAAM,KAAK,IAAI,CAAC,QAAQ;oBACtB,aAAa,KAAK,IAAI;oBACtB,QAAQ;gBACV;gBAEA,oDAAoD;gBACpD,UAAU,CAAC,4CAA4C,EAAE,OAAO,IAAI,CAAC,GAAG,EAAE,mBAAmB,KAAK,IAAI,EAAE,UAAU,CAAC;YACrH,EAAE,OAAO,aAAkB;gBACzB,QAAQ,KAAK,CAAC,mBAAmB,YAAY,OAAO;gBACpD,UAAU,oBAAoB,YAAY,OAAO;YACnD;QACF;QAEA,yDAAyD;QACzD,MAAM,iBAAiB,KAAK,KAAK,CAC/B,QAAQ,GAAG,CAAC,0BAA0B,IAAI;QAE5C,IAAI,eAAe,WAAW,EAAE;YAC9B,eAAe,WAAW,GAAG,eAAe,WAAW,CAAC,OAAO,CAC7D,QACA;QAEJ;QAEA,MAAM,OAAO,IAAI,+JAAM,CAAC,IAAI,CAAC,UAAU,CAAC;YACtC,aAAa;YACb,QAAQ;gBAAC;aAA+C;QAC1D;QAEA,MAAM,SAAS,+JAAM,CAAC,MAAM,CAAC;YAAE,SAAS;YAAM;QAAK;QAEnD,MAAM,OAAO,YAAY,CAAC,MAAM,CAAC,MAAM,CAAC;YACtC,eAAe,QAAQ,GAAG,CAAC,eAAe;YAC1C,OAAO;YACP,kBAAkB;YAClB,aAAa;gBACX,QAAQ;oBACN;wBACE,IAAI,OAAO,cAAc,CAAC,SAAS;4BAAE,UAAU;wBAAa;wBAC5D,eAAe;wBACf,gBAAgB;wBAChB,eAAe;wBACf,2BAA2B;wBAC3B,SAAS;wBACT;qBACD;iBACF;YACH;QACF;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;QAAK;IAC3C,EAAE,OAAO,OAAY;QACnB,QAAQ,KAAK,CAAC,mBAAmB;QACjC,OAAO,gJAAY,CAAC,IAAI,CACtB;YAAE,SAAS;YAAO,OAAO,MAAM,OAAO;QAAC,GACvC;YAAE,QAAQ;QAAI;IAElB;AACF"}}]
}